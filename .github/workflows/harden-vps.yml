name: Harden VPS

on:
  workflow_dispatch:
    inputs:
      vps_host:
        description: 'VPS hostname or IP address (leave empty to use VPS_HOST variable)'
        required: false
        type: string

jobs:
  harden:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Harden VPS
        uses: appleboy/ssh-action@v1.2.3
        env:
          ADMIN_EMAIL: ${{ vars.ADMIN_EMAIL }}
        with:
          host: ${{ inputs.vps_host || vars.VPS_HOST }}
          username: ${{ vars.SSH_USER }}
          port: ${{ vars.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ADMIN_EMAIL
          command_timeout: 30m
          script: |
            set -e

            # Color output
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            BLUE='\033[0;34m'
            NC='\033[0m'

            log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
            log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }
            log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

            log_info "Starting VPS hardening..."
            log_info "Target: $(hostname)"
            log_info "User: $(whoami)"

            # Create workspace directory
            WORKSPACE="/tmp/common-infrastructure-$$"
            mkdir -p ${WORKSPACE}
            cd ${WORKSPACE}

            # Clone repository (using HTTPS, no auth needed for public repo)
            log_step "Cloning common-infrastructure repository..."
            git clone https://github.com/Originate-Group/common-infrastructure.git .

            # Make scripts executable
            chmod +x scripts/*.sh

            # Step 1: System updates
            log_step "Updating system packages..."
            sudo apt-get update -qq
            sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y -qq

            # Step 2: Install essential tools
            log_step "Installing essential tools..."
            sudo apt-get install -y -qq \
              curl \
              wget \
              git \
              vim \
              htop \
              unzip \
              ca-certificates \
              gnupg \
              lsb-release

            # Step 3: Configure automatic security updates
            log_step "Configuring automatic security updates..."
            sudo apt-get install -y -qq unattended-upgrades
            sudo dpkg-reconfigure -plow unattended-upgrades

            # Step 4: Install Docker
            log_step "Installing Docker..."
            if command -v docker &> /dev/null; then
              log_warn "Docker already installed: $(docker --version)"
            else
              sudo ./scripts/setup-docker.sh
            fi

            # Step 5: Install Caddy
            log_step "Installing Caddy web server..."
            if command -v caddy &> /dev/null; then
              log_warn "Caddy already installed: $(caddy version)"
            else
              sudo ./scripts/setup-caddy.sh
            fi

            # Step 6: Configure firewall
            log_step "Configuring UFW firewall..."
            sudo ./scripts/setup-firewall.sh

            # Step 7: Install fail2ban
            log_step "Installing fail2ban..."
            sudo apt-get install -y -qq fail2ban

            # Configure fail2ban for SSH (using brace groups, not heredocs - deployment-sme pattern #1)
            {
              echo "[sshd]"
              echo "enabled = true"
              echo "port = ssh"
              echo "filter = sshd"
              echo "logpath = /var/log/auth.log"
              echo "maxretry = 3"
              echo "bantime = 3600"
              echo "findtime = 600"
            } | sudo tee /etc/fail2ban/jail.local > /dev/null

            sudo systemctl enable fail2ban
            sudo systemctl restart fail2ban

            # Step 8: Install Python venv support (for Python apps)
            log_step "Installing Python venv support..."
            if ! dpkg -l | grep -q "^ii.*python3.*-venv"; then
              sudo apt-get install -y -qq python3-venv python3-pip
            fi

            # Step 9: Harden SSH configuration
            log_step "Hardening SSH configuration..."

            # Backup original sshd_config
            sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

            # Update SSH configuration
            sudo sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
            sudo sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
            sudo sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
            sudo sed -i 's/^#*ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config

            # Test SSH configuration
            if sudo sshd -t; then
              log_info "SSH configuration valid, restarting service..."
              sudo systemctl restart sshd
            else
              log_warn "SSH configuration test failed, reverting..."
              sudo cp /etc/ssh/sshd_config.backup /etc/ssh/sshd_config
              exit 1
            fi

            # Step 10: Set timezone (optional)
            log_step "Setting timezone to UTC..."
            sudo timedatectl set-timezone UTC

            # Cleanup
            log_step "Cleaning up..."
            cd /
            rm -rf ${WORKSPACE}

            # Final status report
            log_info "=== Hardening Complete ==="
            echo ""
            log_info "Installed Services:"
            echo "  Docker: $(docker --version)"
            echo "  Docker Compose: $(docker compose version)"
            echo "  Caddy: $(caddy version)"
            echo "  Python: $(python3 --version)"
            echo ""
            log_info "Security:"
            echo "  Firewall: $(sudo ufw status | head -1)"
            echo "  Fail2ban: $(sudo systemctl is-active fail2ban)"
            echo "  SSH Root Login: Disabled"
            echo "  SSH Password Auth: Disabled"
            echo ""
            log_info "VPS is ready for application deployments!"
            log_info "Each app should write its Caddy config to: /etc/caddy/conf.d/<app-name>.caddy"
